<?xml version="1.0" encoding="utf-8"?>
<!--This azCommand deploys AKS and APIM to Azure cloud
//
// Company: CNSC-CCSN 
// Copyright: Â© CNSC-CCSN 2022. All rights reserved.
// Date Created: 2022-01-27
-->
<azCommands>
    <azCommand  type="execute" name="az global variables">        
        <azParam name="org" value="cnsc" />         
        <azParam name="app" value="svc" />     
        <azParam name="env" value="dev" />  
        <azParam name="instance" value="004" />
        <azParam name="resource-group" value="rg-{{org}}-{{app}}-{{env}}-{{instance}}" />
        <azParam name="location" value="canadaeast" />        
        <azParam name="keyvault" value="kv-{{org}}-{{app}}-{{env}}-{{instance}}" />        
        <azParam name="sb-name" value="sb-{{org}}-{{app}}-{{env}}-{{instance}}" />
        <azParam name="cosmos-db-name" value="cosmos-{{org}}-{{app}}-{{env}}-{{instance}}" />
        <azParam name="acr-name" value="cr{{org}}{{app}}{{env}}{{instance}}" />
        <azParam name="aks-name" value="ks-{{org}}-{{app}}-{{env}}-{{instance}}" />
        <azParam name="aks-resource-group" value="MC_{{resource-group}}}}_{{aks-name}}" />
        <azParam name="vnet" value="aks-vnet-38323365" />
        <azParam name="snet-aks" value="aks-subnet" />
        <azParam name="snet-apim" value="apim-subnet" />
        <azParam name="apim-name" value="apim-{{org}}-{{svc}}-{{env}}-{{instance}}" />
    </azCommand>
    <azCommand  type="execute" name="az account set">
        <azParam name="subscription" value="Dev 12" />
    </azCommand>
    <azCommand  type="execute" name="az group create">
        <azParam name="name" value="{{resource-group}}" />
        <azParam name="location" value="{{location}}" />
    </azCommand>
    <azCommand  type="execute" name="az keyvault create">
        <azParam name="name" value="{{keyvault}}" />
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="location" value="{{location}}" />
    </azCommand>    
    <azCommand  type="execute" name="az servicebus namespace create">
        <azParam name="name" value="{{sb-name}}" />
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="location" value="{{location}}" />
        <azParam name="sku" value="Standard" />
    </azCommand>
    <azCommand  type="query" name="az servicebus namespace authorization-rule keys list" output="{{sb-settings-shared-access-key}}">
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="name" value="RootManageSharedAccessKey" />
        <azParam name="namespace-name" value="{{sb-name}}" />
        <azParam name="query" value="primaryKey" />
        <azParam name="output" value="tsv" />
    </azCommand>
    <azCommand  type="execute" name="az keyvault secret set">
        <azParam name="name" value="azureServiceBusSettingsSharedAccessKey" />
        <azParam name="vault-name" value="{{keyvault}}" />
        <azParam name="value" value="{{sb-settings-shared-access-key}}" />
    </azCommand>
    <azCommand  type="execute" name="az cosmosdb create">
        <azParam name="name" value="{{cosmos-db-name}}" />
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="kind" value="MongoDB" />
        <azParam name="default-consistency-level" value="Eventual" />
        <azParam name="enable-automatic-failover" value="true" />
        <azParam name="server-version" value="4.0" />
        <azParam name="locations" value="regionName=canadacentral failoverPriority=0 isZoneRedundant=False" />
    </azCommand>
    <azCommand  type="execute" name="az keyvault secret set">
        <azParam name="name" value="eventStoreSettingsPassword" />
        <azParam name="vault-name" value="{{keyvault}}" />
        <azParam name="value" value="changeit" />
    </azCommand>
    <azCommand  type="execute" name="az acr create">
        <azParam name="name" value="{{acr-name}}" />
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="location" value="{{location}}" />
        <azParam name="sku" value="Standard" />
    </azCommand>
    <azCommand  type="query" name="az aks get-versions" output="{{aks-latest-version}}">
        <azParam name="location" value="{{location}}" />
        <azParam name="query" value="orchestrators[-1].orchestratorVersion" />
        <azParam name="output" value="tsv" />
    </azCommand>
    <azCommand  type="execute" name="az aks create">
        <azParam name="name" value="{{aks-name}}" />
        <azParam name="resource-group" value="{{resource-group}}" />
        <azParam name="location" value="{{location}}" />
        <azParam name="node-count" value="1" />
        <!--azParam name="service-principal" value="{{app-id}}" />
        <azParam name="client-secret" value="{{sp-password}}" /-->
        <azParam name="load-balancer-sku" value="standard" />
        <azParam name="kubernetes-version" value="{{aks-latest-version}}" />
        <azParam name="network-plugin" value="kubenet" />
        <!--azParam name="vnet-subnet-id" value="{{aks-subnet-id}}" />
        <azParam name="service-cidr" value="10.0.0.0/16" />
        <azParam name="dns-service-ip" value="10.0.0.10" />
        <azParam name="docker-bridge-address" value="172.17.0.1/16" /-->
        <azParam name="node-vm-size" value="Standard_B2s" />
        <azParam name="enable-addons" value="monitoring" />
        <azParam name="attach-acr" value="{{acr-name}}" />
        <azParam name="ssh-key-value" value="C:\Dev\Temp\aks-ssh-service.pub" />
    </azCommand>
    <azCommand  type="execute" name="az apim create">
        <azParam name="name" value="{{apim-name}}" />
        <azParam name="resource-group" value="{{aks-resource-group}}" />
        <azParam name="location" value="{{location}}" />
        <azParam name="publisher-email" value="ASD-SDA@cnsc-ccsn.gc.ca" />
        <azParam name="publisher-name" value="CNSC-CCSN" />
        <azParam name="virtual-network" value="External" />
    </azCommand>
    <azCommand  type="query" name="az apim show" output="{{apim-id}}">
        <azParam name="name" value="{{apim-name}}" />
        <azParam name="resource-group" value="{{aks-resource-group}}" />
        <azParam name="query" value="id" />
        <azParam name="output" value="tsv" />
    </azCommand>
    <azCommand  type="query" name="az network vnet show" output="{{vnet-id}}">
        <azParam name="name" value="{{vnet}}" />
        <azParam name="resource-group" value="{{aks-resource-group}}" />
        <azParam name="query" value="id" />
        <azParam name="output" value="tsv" />
    </azCommand>
    <azCommand  type="execute" name="az network vnet subnet create">
        <azParam name="name" value="{{snet-apim}}" />
        <azParam name="resource-group" value="{{aks-resource-group}}" />
        <azParam name="vnet-name" value="{{vnet}}" />
        <azParam name="address-prefixes" value="10.240.1.0/16" />
    </azCommand>
    <azCommand  type="query" name="az network vnet subnet show" output="{{apim-subnet-id}}">
        <azParam name="resource-group" value="aks-resource-group" />
        <azParam name="vnet-name" value="{{vnet}}" />
        <azParam name="name" value="snet-apim" />
        <azParam name="query" value="id" />
        <azParam name="output" value="tsv" />
    </azCommand>
    <azCommand  type="execute" name="az resource update">
        <azParam name="ids" value="{{apim-id}}" />
        <azParam name="set" value="properties.virtualNetworkConfiguration.subnetResourceId={{apim-subnet-id}}" />
    </azCommand>
</azCommands>

